# GitHub Action: Docker Build & Push with Buildx

This guide explains how to use the [`docker/build-push-action`](https://github.com/docker/build-push-action) v6 GitHub Action to build and push Docker images with the full capabilities of the Moby BuildKit toolkit. It covers the default Git-based workflow, path-based contexts, multi-platform builds, cache management, secrets handling, attestations, and more.

---

## üì∏ Screenshot

The Buildx action produces a rich job summary that captures the executed steps, build metadata, and download links for build records. Use this summary to review build inputs, inspect logs, and import the record into Docker Desktop for deeper analysis.

> **Tip:** If your workflow also downloads artifacts with `actions/download-artifact`, exclude files that match `*.dockerbuild` (for example with `pattern: "!*.dockerbuild"`) to avoid failures triggered by the build record artifact.

---

## üöÄ Usage Overview

Most workflows combine the Buildx action with complementary actions that set up the build environment:

1. **`docker/login-action@v3`** ‚Äì Authenticates against Docker Hub or another registry.
2. **`docker/setup-qemu-action@v3`** ‚Äì Adds QEMU emulation for building additional CPU architectures.
3. **`docker/setup-buildx-action@v3`** ‚Äì Boots a Buildx builder (Docker container driver by default) that enables multi-platform builds, caching, and advanced BuildKit features.
4. **`docker/build-push-action@v6`** ‚Äì Builds, tests, and optionally pushes images.

```yaml
name: ci

on:
  push:

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: user/app:latest
```

---

## üåø Git Context

By default the Buildx action builds directly from the Git reference associated with the triggering event. That means:

- You **do not need** to run `actions/checkout` because BuildKit fetches sources directly from the Git repository.
- The default context URL is `https://github.com/<owner>/<repo>.git#<ref>`.
- Any file mutations performed by preceding steps are ignored because the build references committed sources.
- `.dockerignore` rules in the workspace are not applied to the Git context.

### Selecting a Subdirectory

Use the `{{defaultContext}}` Handlebars template to target a subdirectory inside the Git context:

```yaml
- name: Build and push (subdirectory)
  uses: docker/build-push-action@v6
  with:
    context: "{{defaultContext}}:mysubdir"
    push: true
    tags: user/app:latest
```

### Authenticating to Private Git Repositories

When building from the current repository, GitHub automatically supplies the workflow token, so no extra configuration is required. To use private dependencies stored elsewhere, inject a token with the `secrets` input:

```yaml
- name: Build and push (private dependency)
  uses: docker/build-push-action@v6
  with:
    push: true
    tags: user/app:latest
    secrets: |
      GIT_AUTH_TOKEN=${{ secrets.MYTOKEN }}
```

---

## üìÅ Path Context

Switch to a path-based context when you need the build to reflect files generated by earlier steps (e.g., code generation, templating, or `.dockerignore` updates). In this mode you **must** check out the repository first.

```yaml
name: ci

on:
  push:

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push (workspace context)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: user/app:latest
```

---

## üß™ Feature Examples

Explore these scenarios to unlock the full power of BuildKit through the action:

- **Multi-platform builds** ‚Äì Define `platforms` to publish manifests that target multiple architectures.
- **Secrets and SSH forwarding** ‚Äì Use `secrets`, `secret-envs`, `secret-files`, and `ssh` to securely pass credentials into the build.
- **Remote cache** ‚Äì Combine `cache-from` and `cache-to` to reuse layers between workflows and speed up builds.
- **Custom tags & labels** ‚Äì Automate semantic tagging, add OCI labels, and push to multiple registries.
- **Local testing before push** ‚Äì Set `push: false` and `load: true` to load the image into the local Docker daemon for smoke tests.
- **Attestations** ‚Äì Configure `sbom`, `provenance`, or `attests` to generate SBOMs and SLSA provenance attestations.
- **Named contexts** ‚Äì Provide additional `build-contexts` for advanced Dockerfile patterns.
- **Image promotion** ‚Äì Copy images between registries or update Docker Hub repository descriptions.

---

## ‚öôÔ∏è Inputs Reference

All inputs map directly to Buildx command-line flags. Use newline-delimited strings for list inputs and comma-delimited strings for CSV inputs.

| Name | Type | Description |
| --- | --- | --- |
| `add-hosts` | List / CSV | Define custom host-to-IP mappings (`docker:10.180.0.1`). |
| `allow` | List / CSV | Enable extra BuildKit entitlements (`network.host`, `security.insecure`). |
| `annotations` | List | Attach annotations to the resulting image. |
| `attests` | List | Configure attestations, e.g., `type=sbom,generator=image`. |
| `builder` | String | Name of the Buildx builder instance (from `setup-buildx`). |
| `build-args` | List | Build-time variables (`ARG`). |
| `build-contexts` | List | Additional build contexts (`name=path`). |
| `cache-from` | List | External cache sources (`type=local,src=path/to/dir`). |
| `cache-to` | List | Cache export targets (`type=local,dest=path/to/dir`). |
| `call` | String | Evaluate build with alternative methods such as `check`. |
| `cgroup-parent` | String | Parent cgroup for the build container. |
| `context` | String | Path or URL for the build context (Git by default). |
| `file` | String | Dockerfile path (defaults to `{context}/Dockerfile`). |
| `labels` | List | Metadata labels for the image. |
| `load` | Bool | Shorthand for `--output=type=docker`. |
| `network` | String | Networking mode for `RUN` instructions. |
| `no-cache` | Bool | Disable all caching. |
| `no-cache-filters` | List / CSV | Disable cache for specific stages. |
| `outputs` | List | Define custom outputs (`type=local,dest=path`). |
| `platforms` | List / CSV | Target platforms (`linux/amd64,linux/arm64`). |
| `provenance` | Bool / String | Generate provenance attestations (`--attest=type=provenance`). |
| `pull` | Bool | Always attempt to pull referenced images. |
| `push` | Bool | Shorthand for `--output=type=registry`. |
| `sbom` | Bool / String | Generate SBOM attestations. |
| `secrets` | List | Expose arbitrary secrets (`key=value`). |
| `secret-envs` | List / CSV | Map environment variables as secrets. |
| `secret-files` | List | Provide secret files (`key=filename`). |
| `shm-size` | String | Size of `/dev/shm` (`2g`). |
| `ssh` | List | Forward SSH agent sockets or keys. |
| `tags` | List / CSV | Publish tags (`repo/name:tag`). |
| `target` | String | Select build stage. |
| `ulimit` | List | Configure ulimits (`nofile=1024:1024`). |
| `github-token` | String | Token for Git-based contexts (defaults to `${{ github.token }}`). |

---

## üì§ Outputs

| Name | Description |
| --- | --- |
| `imageid` | The resulting image ID. |
| `digest` | The pushed image digest (useful for immutable references). |
| `metadata` | JSON object containing build result metadata. |

---

## üåê Environment Variables

| Variable | Default | Description |
| --- | --- | --- |
| `DOCKER_BUILD_CHECKS_ANNOTATIONS` | `true` | Disable GitHub annotations for build checks when set to `false`. |
| `DOCKER_BUILD_SUMMARY` | `true` | Disable job summary generation when set to `false`. |
| `DOCKER_BUILD_RECORD_UPLOAD` | `true` | Prevent build record artifacts from uploading when set to `false`. |
| `DOCKER_BUILD_RECORD_RETENTION_DAYS` | _Unset_ | Override artifact retention period (defaults to repo/org settings when `0` or unset). |
| `DOCKER_BUILD_EXPORT_LEGACY` | `false` | Export build data using the legacy `export-build` tool instead of Buildx history export. |

---

## üõ†Ô∏è Troubleshooting Checklist

1. **Missing sources or `.dockerignore` not applied?** Switch from the Git context to a path context (`context: .`) and ensure `actions/checkout` runs first.
2. **Build record download failures?** Update any `actions/download-artifact` usage to ignore `*.dockerbuild` files or specify an explicit pattern.
3. **Authentication errors when fetching dependencies?** Provide `GIT_AUTH_TOKEN` or registry credentials via `secrets`.
4. **Multi-platform build failures?** Confirm QEMU is enabled (`setup-qemu-action`) and the builder driver supports multi-platform builds (Docker container driver or remote driver).
5. **Cache not restoring?** Verify `cache-from` references a valid cache source and that the builder has permission to access it.

---

## üìö Additional Resources

- [docker/build-push-action Documentation](https://github.com/docker/build-push-action)
- [BuildKit Reference](https://docs.docker.com/build/buildkit/)
- [Buildx CLI Guide](https://docs.docker.com/build/buildx/manual/)

